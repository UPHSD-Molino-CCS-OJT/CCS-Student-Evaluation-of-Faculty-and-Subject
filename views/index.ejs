<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPHSD Student Faculty Evaluation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .rating-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .rating-option {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 4px;
            background: linear-gradient(to right, #3b82f6, #10b981);
            transition: width 0.3s ease;
            z-index: 9999;
        }
        .section-complete {
            border-left-color: #10b981 !important;
        }
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .floating-save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(100px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        .floating-save-indicator.show {
            transform: translateY(0);
        }
        .required-indicator {
            color: #ef4444;
            font-weight: bold;
        }
        input:invalid, select:invalid {
            border-color: #fca5a5;
        }
        input:valid, select:valid {
            border-color: #86efac;
        }
        .highlight-error {
            border: 2px solid #ef4444 !important;
            background-color: #fef2f2 !important;
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .section-header {
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        .section-header:hover {
            background-color: #f3f4f6;
        }
        .section-content {
            max-height: 5000px;
            overflow: hidden;
            transition: max-height 0.5s ease;
        }
        .section-content.collapsed {
            max-height: 0;
        }
        .chevron {
            transition: transform 0.3s ease;
        }
        .chevron.rotated {
            transform: rotate(180deg);
        }
        .navbar {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .admin-login-btn {
            transition: all 0.3s ease;
        }
        .admin-login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,255,255,0.2);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="max-w-7xl mx-auto px-4 py-3 md:py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2 md:space-x-3">
                    <i class="fas fa-graduation-cap text-white text-xl md:text-2xl"></i>
                    <div>
                        <h1 class="text-white font-bold text-sm md:text-lg">UPHSD - Molino Campus</h1>
                        <p class="text-blue-100 text-xs hidden sm:block">Faculty Evaluation System</p>
                    </div>
                </div>
                <a href="/admin/login" class="admin-login-btn bg-white text-blue-900 px-3 md:px-6 py-2 rounded-lg font-semibold hover:bg-blue-50 flex items-center space-x-1 md:space-x-2 text-sm md:text-base">
                    <i class="fas fa-user-shield"></i>
                    <span class="hidden sm:inline">Admin Login</span>
                    <span class="sm:hidden">Admin</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Progress Bar -->
    <div class="progress-bar" id="progressBar"></div>
    
    <!-- Auto-save Indicator -->
    <div class="floating-save-indicator" id="saveIndicator">
        <i class="fas fa-check-circle mr-2"></i>Draft saved
    </div>

    <div class="min-h-screen py-8 px-4">
        <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-8">
            <!-- Header -->
            <div class="sticky-header text-center p-4 -m-8 mb-6 rounded-t-lg">
                <h1 class="text-3xl font-bold text-blue-900 mb-2">UPHSD - Molino Campus</h1>
                <h2 class="text-xl font-semibold text-gray-700">Student Faculty Evaluation</h2>
                <div class="mt-4">
                    <div class="text-sm text-gray-600">
                        <span id="completionText">Progress: 0%</span>
                        <span class="ml-4">Required fields: <span class="required-indicator">*</span></span>
                    </div>
                </div>
            </div>

            <form id="evaluationForm" class="space-y-6" autocomplete="off">
                <!-- Data Privacy Consent -->
                <div id="section-consent" class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                    <h3 class="font-semibold text-gray-800 mb-2">Data Privacy Notice</h3>
                    <p class="text-sm text-gray-700 mb-4">
                        The University of Perpetual Help System DALTA respects your right to privacy and the confidentiality of your personal information. 
                        It is the policy of UPHSD to respect and uphold data privacy rights and to ensure that all personal data collected from students, 
                        their parents or guardians, employees and other third parties, are processed pursuant to the general principles of transparency, 
                        legitimate purpose, and proportionality as stated in the Republic Act No. 10173, otherwise known as the Data Privacy Act of 2012 ("DPA").
                    </p>
                    <p class="text-sm text-gray-700 mb-4">
                        By filling out this survey, I hereby allow/authorize UPHSD - Molino Campus to use, collect and process the information for 
                        legitimate purpose specifically this Student Faculty Evaluation and allow to authorized UPHSD Personnel to process the information, 
                        store and save in sufficiently secured and protected database and even destroy the same in accordance with the laws, rules and regulations.
                    </p>
                    <div class="flex items-center">
                        <input type="checkbox" id="consent" name="consent" required 
                               class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="consent" class="ml-2 text-sm font-medium text-gray-900">
                            I agree to the terms stated above *
                        </label>
                    </div>
                </div>

                <!-- School Year -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">School Year *</label>
                    <input type="text" name="schoolYear" id="schoolYear" required 
                           placeholder="e.g., 2025-2026"
                           value="2025-2026"
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Student Number -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Student Number *</label>
                    <input type="text" name="studentNumber" id="studentNumber" required 
                           placeholder="Format: 00-0000-000"
                           pattern="\d{2}-\d{4}-\d{3}"
                           maxlength="12"
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Format: 00-0000-000 (Type numbers only)</p>
                </div>

                <!-- Program -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Program *</label>
                    <select name="program" id="program" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select Program</option>
                        <% programs.forEach(program => { %>
                            <option value="<%= program.id %>"><%= program.name %></option>
                        <% }); %>
                    </select>
                </div>

                <!-- Year Level -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Year Level *</label>
                    <select name="yearLevel" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select Year Level</option>
                        <option value="1st">1st Year</option>
                        <option value="2nd">2nd Year</option>
                        <option value="3rd">3rd Year</option>
                        <option value="4th">4th Year</option>
                    </select>
                </div>

                <!-- Status -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                    <div class="flex gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="status" value="Regular" required 
                                   class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-2 text-gray-700">Regular</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="status" value="Irregular" required 
                                   class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-2 text-gray-700">Irregular</span>
                        </label>
                    </div>
                </div>

                <!-- Course -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Course/Subject *</label>
                    <select name="course" id="course" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select Program First</option>
                    </select>
                </div>

                <!-- Teacher Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Name of Teacher *</label>
                    <select name="teacher" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select Teacher</option>
                        <% teachers.forEach(teacher => { %>
                            <option value="<%= teacher.id %>"><%= teacher.full_name %></option>
                        <% }); %>
                    </select>
                </div>

                <!-- Rating Scale Legend -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-gray-800 mb-3">Rating Scale</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-2 text-sm">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-green-600">5</span>
                            <span class="text-gray-700">Outstanding</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-blue-600">4</span>
                            <span class="text-gray-700">High Satisfactory</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-yellow-600">3</span>
                            <span class="text-gray-700">Satisfactory</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-orange-600">2</span>
                            <span class="text-gray-700">Fairly Satisfactory</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-red-600">1</span>
                            <span class="text-gray-700">Needs Improvement</span>
                        </div>
                    </div>
                </div>

                <!-- THE TEACHER Section -->
                <div class="border-t-4 border-blue-500 pt-6">
                    <div class="section-header flex justify-between items-center p-4 bg-gray-50 rounded-lg mb-4" onclick="toggleSection('teacher')">
                        <h3 class="text-xl font-bold text-gray-800">THE TEACHER</h3>
                        <i class="fas fa-chevron-down chevron text-gray-600" id="chevron-teacher"></i>
                    </div>
                    
                    <div class="section-content" id="content-teacher">
                        <div class="space-y-4">
                            <% const teacherQuestions = [
                                "Clarity's of diction (voice projection)",
                                "Use of correct grammar (and appropriate words)",
                                "Personality (Grooming and attire)",
                                "Disposition (Composure and sense of humor)",
                                "Dynamic and interesting in sharing of ideas",
                                "Just and fair in dealings with students (No favoritism)"
                            ]; %>
                            
                            <% teacherQuestions.forEach((question, index) => { %>
                                <div class="bg-gray-50 p-4 rounded">
                                    <p class="text-sm font-medium text-gray-700 mb-3"><%= index + 1 %>. <%= question %> *</p>
                                    <div class="flex flex-wrap gap-4">
                                        <% for(let i = 1; i <= 5; i++) { %>
                                            <label class="rating-option cursor-pointer">
                                                <input type="radio" name="teacher_<%= index + 1 %>" value="<%= i %>" required
                                                       class="w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500">
                                                <span class="text-sm mt-1 text-gray-600"><%= i %></span>
                                            </label>
                                        <% } %>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                </div>

                <!-- THE TEACHER LEARNING PROCESS Section -->
                <div class="border-t-4 border-green-500 pt-6">
                    <div class="section-header flex justify-between items-center p-4 bg-gray-50 rounded-lg mb-4" onclick="toggleSection('learning')">
                        <h3 class="text-xl font-bold text-gray-800">THE TEACHER LEARNING PROCESS</h3>
                        <i class="fas fa-chevron-down chevron text-gray-600" id="chevron-learning"></i>
                    </div>
                    
                    <div class="section-content collapsed" id="content-learning">
                        <div class="space-y-4">
                            <% const learningQuestions = [
                                "Motivation (Ability to sustain students' interest)",
                                "Encouragement given to students to develop critical thinking",
                                "Organization of lessons / lectures",
                                "Interest on ensuring that students are learning the lessons",
                                "The teacher can very well explain words and concepts",
                                "Clarity in the Formulation of questions",
                                "Integration of subject matter to life situations",
                                "Mastery of teaching the subject (not bookish)",
                                "Teaching methodology is dynamic and interesting",
                                "Integration of perpetualite values to the lessons",
                                "Fair and just in giving grades in Exams, assignments and recitations",
                                "Ability to synthesize learning activities",
                                "Reasonableness of quizzes and examinations"
                            ]; %>
                            
                            <% learningQuestions.forEach((question, index) => { %>
                                <div class="bg-gray-50 p-4 rounded">
                                    <p class="text-sm font-medium text-gray-700 mb-3"><%= index + 1 %>. <%= question %> *</p>
                                    <div class="flex flex-wrap gap-4">
                                        <% for(let i = 1; i <= 5; i++) { %>
                                            <label class="rating-option cursor-pointer">
                                                <input type="radio" name="learning_<%= index + 1 %>" value="<%= i %>" required
                                                       class="w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500">
                                                <span class="text-sm mt-1 text-gray-600"><%= i %></span>
                                            </label>
                                        <% } %>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                </div>

                <!-- THE CLASSROOM MANAGEMENT Section -->
                <div class="border-t-4 border-purple-500 pt-6">
                    <div class="section-header flex justify-between items-center p-4 bg-gray-50 rounded-lg mb-4" onclick="toggleSection('classroom')">
                        <h3 class="text-xl font-bold text-gray-800">THE CLASSROOM MANAGEMENT</h3>
                        <i class="fas fa-chevron-down chevron text-gray-600" id="chevron-classroom"></i>
                    </div>
                    
                    <div class="section-content collapsed" id="content-classroom">
                        <div class="space-y-4">
                            <% const classroomQuestions = [
                                "Regularity of checking students' attendance",
                                "Ability to convey classroom policies to students",
                                "Maintenance of classroom discipline",
                                "Exercise of Reasonable authority in the classroom (hindi nananakot)",
                                "Recitation of opening and / or closing prayers",
                                "Punctuality in Starting and Ending of class"
                            ]; %>
                            
                            <% classroomQuestions.forEach((question, index) => { %>
                                <div class="bg-gray-50 p-4 rounded">
                                    <p class="text-sm font-medium text-gray-700 mb-3"><%= index + 1 %>. <%= question %> *</p>
                                    <div class="flex flex-wrap gap-4">
                                        <% for(let i = 1; i <= 5; i++) { %>
                                            <label class="rating-option cursor-pointer">
                                                <input type="radio" name="classroom_<%= index + 1 %>" value="<%= i %>" required
                                                       class="w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500">
                                                <span class="text-sm mt-1 text-gray-600"><%= i %></span>
                                            </label>
                                        <% } %>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                </div>

                <!-- Comments Section -->
                <div class="border-t-4 border-orange-500 pt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Comments / Suggestions for Improvement
                    </label>
                    <textarea name="comments" rows="5"
                              placeholder="Please share your suggestions or remarks for the teacher..."
                              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-center gap-4 pt-6">
                    <button type="button" id="clearDraft"
                            class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition duration-300">
                        Clear Draft
                    </button>
                    <button type="submit" id="submitBtn"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Submit Evaluation
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 transform transition-all">
            <!-- Close button -->
            <button onclick="closeSuccessModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition">
                <i class="fas fa-times text-xl"></i>
            </button>
            
            <div class="p-8 text-center">
                <!-- Success icon with animation -->
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
                    <i class="fas fa-check-circle text-green-600 text-3xl"></i>
                </div>
                
                <!-- Title -->
                <h3 class="text-2xl font-bold text-gray-900 mb-3">Evaluation Submitted!</h3>
                
                <!-- Message -->
                <p class="text-gray-600 mb-6 leading-relaxed">
                    Thank you for taking the time to complete this evaluation. Your feedback is valuable and will help improve our faculty and courses.
                </p>
                
                <!-- Success details -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                    <div class="flex items-center justify-center gap-2 text-green-700">
                        <i class="fas fa-info-circle"></i>
                        <span class="text-sm">Your response has been recorded successfully</span>
                    </div>
                </div>
                
                <!-- Action button -->
                <button id="closeModal"
                        class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 transform hover:scale-105">
                    <i class="fas fa-home mr-2"></i>Back to Home
                </button>
            </div>
        </div>
    </div>

    <script>
        // Find first invalid/empty required field
        function findFirstInvalidField(form) {
            // Check text inputs and selects
            const requiredFields = form.querySelectorAll('[required]');
            for (let field of requiredFields) {
                if (field.type === 'radio') {
                    // For radio buttons, check if any in the group is checked
                    const radioGroup = form.querySelectorAll(`[name="${field.name}"]`);
                    if (!Array.from(radioGroup).some(r => r.checked)) {
                        return field;
                    }
                } else if (field.type === 'checkbox') {
                    if (!field.checked) {
                        return field;
                    }
                } else {
                    if (!field.value || field.value === '') {
                        return field;
                    }
                }
            }
            return null;
        }

        // Scroll to and highlight invalid field
        function scrollToInvalidField(field) {
            // Determine which section the field belongs to
            const sectionMapping = {
                'content-teacher': 'teacher',
                'content-learning': 'learning',
                'content-classroom': 'classroom'
            };
            
            let sectionName = null;
            for (let [contentId, name] of Object.entries(sectionMapping)) {
                const content = document.getElementById(contentId);
                if (content && content.contains(field)) {
                    sectionName = name;
                    break;
                }
            }
            
            // Open the section if it's collapsed
            if (sectionName) {
                const content = document.getElementById('content-' + sectionName);
                const chevron = document.getElementById('chevron-' + sectionName);
                if (content && content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    chevron.classList.add('rotated');
                }
            }
            
            // Highlight the field
            field.classList.add('highlight-error');
            
            // Scroll to the field
            setTimeout(() => {
                const yOffset = -100;
                const y = field.getBoundingClientRect().top + window.pageYOffset + yOffset;
                window.scrollTo({ top: y, behavior: 'smooth' });
                
                // Remove highlight after 3 seconds
                setTimeout(() => {
                    field.classList.remove('highlight-error');
                }, 3000);
            }, 200);
            
            // Show alert
            alert('Please fill in all required fields. The first empty field has been highlighted.');
        }

        // Toggle section collapse/expand (accordion behavior - only one section open at a time)
        function toggleSection(sectionName) {
            const allSections = ['teacher', 'learning', 'classroom'];
            const content = document.getElementById('content-' + sectionName);
            const chevron = document.getElementById('chevron-' + sectionName);
            
            // Close all other sections
            allSections.forEach(section => {
                if (section !== sectionName) {
                    const otherContent = document.getElementById('content-' + section);
                    const otherChevron = document.getElementById('chevron-' + section);
                    if (otherContent && !otherContent.classList.contains('collapsed')) {
                        otherContent.classList.add('collapsed');
                        otherChevron.classList.remove('rotated');
                    }
                }
            });
            
            // Toggle current section
            const isExpanding = content.classList.contains('collapsed');
            content.classList.toggle('collapsed');
            chevron.classList.toggle('rotated');
            
            // Scroll to the section header when expanding
            if (isExpanding) {
                setTimeout(() => {
                    const headerElement = chevron.closest('.section-header');
                    if (headerElement) {
                        const yOffset = -20; // 20px offset from top
                        const y = headerElement.getBoundingClientRect().top + window.pageYOffset + yOffset;
                        window.scrollTo({ top: y, behavior: 'smooth' });
                    }
                }, 150);
            }
        }
        
        // Auto-format student number as user types
        document.getElementById('studentNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, ''); // Remove all non-digits
            let formatted = '';
            
            if (value.length > 0) {
                formatted = value.substring(0, 2); // First 2 digits
            }
            if (value.length > 2) {
                formatted += '-' + value.substring(2, 6); // Next 4 digits
            }
            if (value.length > 6) {
                formatted += '-' + value.substring(6, 9); // Last 3 digits
            }
            
            e.target.value = formatted;
        });
        
        // Auto-save draft functionality
        let saveTimeout;
        const DRAFT_KEY = 'evaluation_draft';
        const saveIndicator = document.getElementById('saveIndicator');
        
        // Load draft on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadDraft();
            updateProgress();
            
            // Show help tooltip
            if (!localStorage.getItem('helpShown')) {
                setTimeout(() => {
                    alert('ðŸ’¡ Tip: Your progress is automatically saved as you fill out the form. You can close this page and come back later!');
                    localStorage.setItem('helpShown', 'true');
                }, 1000);
            }
        });
        
        // Save draft automatically
        function saveDraft() {
            const formData = new FormData(document.getElementById('evaluationForm'));
            const data = Object.fromEntries(formData);
            localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
            
            // Show save indicator
            saveIndicator.classList.add('show');
            setTimeout(() => {
                saveIndicator.classList.remove('show');
            }, 2000);
        }
        
        // Load draft from localStorage
        function loadDraft() {
            const draft = localStorage.getItem(DRAFT_KEY);
            if (draft) {
                const data = JSON.parse(draft);
                Object.keys(data).forEach(key => {
                    const element = document.querySelector(`[name="${key}"]`);
                    if (element) {
                        if (element.type === 'radio' || element.type === 'checkbox') {
                            const radioElement = document.querySelector(`[name="${key}"][value="${data[key]}"]`);
                            if (radioElement) radioElement.checked = true;
                        } else {
                            element.value = data[key];
                        }
                    }
                });
                
                // Trigger program change to load courses
                const programSelect = document.getElementById('program');
                if (programSelect.value) {
                    programSelect.dispatchEvent(new Event('change'));
                }
                
                updateProgress();
            }
        }
        
        // Clear draft
        document.getElementById('clearDraft').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear your draft? This cannot be undone.')) {
                localStorage.removeItem(DRAFT_KEY);
                document.getElementById('evaluationForm').reset();
                updateProgress();
                alert('Draft cleared successfully!');
            }
        });
        
        // Auto-save on input change
        document.getElementById('evaluationForm').addEventListener('input', function() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveDraft, 1000);
            updateProgress();
        });
        
        document.getElementById('evaluationForm').addEventListener('change', function() {
            saveDraft();
            updateProgress();
        });
        
        // Update progress bar
        function updateProgress() {
            const form = document.getElementById('evaluationForm');
            const requiredFields = form.querySelectorAll('[required]');
            let completed = 0;
            
            requiredFields.forEach(field => {
                if (field.type === 'radio') {
                    const radioGroup = form.querySelectorAll(`[name="${field.name}"]`);
                    if (Array.from(radioGroup).some(r => r.checked)) {
                        completed++;
                    }
                } else if (field.type === 'checkbox') {
                    if (field.checked) completed++;
                } else if (field.value.trim() !== '') {
                    completed++;
                }
            });
            
            const percentage = Math.round((completed / requiredFields.length) * 100);
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('completionText').textContent = `Progress: ${percentage}%`;
            
            // Mark sections as complete
            const sections = ['consent', 'info', 'teacher', 'learning', 'classroom'];
            sections.forEach(section => {
                const sectionElement = document.getElementById(`section-${section}`);
                if (sectionElement) {
                    const sectionFields = sectionElement.querySelectorAll('[required]');
                    let sectionComplete = true;
                    sectionFields.forEach(field => {
                        if (field.type === 'radio') {
                            const radioGroup = form.querySelectorAll(`[name="${field.name}"]`);
                            if (!Array.from(radioGroup).some(r => r.checked)) {
                                sectionComplete = false;
                            }
                        } else if (!field.value || !field.checked) {
                            sectionComplete = false;
                        }
                    });
                    if (sectionComplete) {
                        sectionElement.classList.add('section-complete');
                    } else {
                        sectionElement.classList.remove('section-complete');
                    }
                }
            });
        }

        // Update courses based on program selection
        document.getElementById('program').addEventListener('change', async function() {
            const courseSelect = document.getElementById('course');
            const programId = this.value;
            
            courseSelect.innerHTML = '<option value="">Loading...</option>';
            
            if (programId) {
                try {
                    const response = await fetch(`/api/courses/${programId}`);
                    const courses = await response.json();
                    
                    courseSelect.innerHTML = '<option value="">Select Course</option>';
                    courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course._id; // MongoDB uses _id not id
                        option.textContent = course.name;
                        courseSelect.appendChild(option);
                    });
                    
                    // Restore selected course from draft
                    const draft = localStorage.getItem(DRAFT_KEY);
                    if (draft) {
                        const data = JSON.parse(draft);
                        if (data.course) {
                            courseSelect.value = data.course;
                        }
                    }
                } catch (error) {
                    console.error('Error loading courses:', error);
                    courseSelect.innerHTML = '<option value="">Error loading courses</option>';
                }
            } else {
                courseSelect.innerHTML = '<option value="">Select Program First</option>';
            }
        });

        // Form submission
        document.getElementById('evaluationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate all required fields
            if (!this.checkValidity()) {
                // Find the first empty required field
                const firstInvalidField = findFirstInvalidField(this);
                if (firstInvalidField) {
                    // Open the section containing the invalid field and scroll to it
                    scrollToInvalidField(firstInvalidField);
                }
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch('/submit-evaluation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Clear draft after successful submission
                    localStorage.removeItem(DRAFT_KEY);
                    document.getElementById('successModal').classList.remove('hidden');
                    this.reset();
                    updateProgress();
                } else {
                    alert('Error: ' + result.message);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Evaluation';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while submitting the form. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Evaluation';
            }
        });

        // Close modal
        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        document.getElementById('closeModal').addEventListener('click', closeSuccessModal);
        
        // Close modal when clicking outside
        document.getElementById('successModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSuccessModal();
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S to save draft
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveDraft();
                alert('Draft saved!');
            }
        });
        
        // Smooth scroll to first error
        document.getElementById('evaluationForm').addEventListener('invalid', function(e) {
            e.preventDefault();
            const firstInvalid = this.querySelector(':invalid');
            if (firstInvalid) {
                firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalid.focus();
            }
        }, true);
    </script>
</body>
</html>
